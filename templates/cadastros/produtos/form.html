{% extends 'base/dashboard_base.html' %}

{% block title %}{{ form_title }} - {{ empresa.nome }} - Costurai.com.br{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para o formulário de produtos */
    .form-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .form-card-header {
        padding: 24px 28px 20px;
        border-bottom: 1px solid var(--gray-200);
        background: white;
    }
    
    .form-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-card-title i {
        color: var(--primary-blue-light);
    }
    
    .form-card-body {
        padding: 28px;
    }
    
    .form-grid {
        display: grid;
        gap: 20px;
    }
    
    .form-grid.cols-2 {
        grid-template-columns: 1fr 1fr;
    }
    
    .form-grid.cols-3 {
        grid-template-columns: 1fr 1fr 1fr;
    }
    
    .form-grid.cols-4 {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 6px;
    }
    
    .form-label.required:after {
        content: ' *';
        color: var(--danger);
    }
    
    .form-control {
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        padding: 12px 14px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
    }
    
    .form-control:focus {
        border-color: var(--primary-blue-light);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .form-control.error {
        border-color: var(--danger);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }
    
    .form-help {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 4px;
    }
    
    .error-message {
        background: var(--danger-light);
        color: var(--danger);
        padding: 8px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.8125rem;
        margin-top: 4px;
        border: 1px solid #fecaca;
    }
    
    /* Image Upload */
    .image-upload-area {
        border: 2px dashed var(--gray-300);
        border-radius: var(--border-radius-sm);
        padding: 32px;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .image-upload-area:hover {
        border-color: var(--primary-blue-light);
        background: var(--accent-blue);
    }
    
    .image-upload-area.has-image {
        border-style: solid;
        border-color: var(--success);
        background: var(--success-light);
    }
    
    .upload-icon {
        font-size: 2rem;
        color: var(--gray-400);
        margin-bottom: 12px;
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: var(--border-radius-sm);
        margin: 12px auto;
        display: block;
        border: 1px solid var(--gray-200);
    }
    
    /* Matérias-Primas Section */
    .materias-primas-section {
        background: var(--gray-50);
        border-radius: var(--border-radius-sm);
        padding: 20px;
        margin-top: 20px;
    }
    
    .materia-prima-item {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        padding: 16px;
        margin-bottom: 12px;
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 16px;
        align-items: end;
    }
    
    .materia-prima-item:last-child {
        margin-bottom: 0;
    }
    
    .btn-add-materia {
        background: var(--success);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-add-materia:hover {
        background: #059669;
        transform: translateY(-1px);
    }
    
    .btn-remove-materia {
        background: var(--danger);
        color: white;
        border: none;
        padding: 6px 8px;
        border-radius: var(--border-radius-sm);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-remove-materia:hover {
        background: #dc2626;
    }
    
    /* Tamanhos Section - Layout Horizontal */
    .tamanhos-section {
        background: var(--gray-50);
        border-radius: var(--border-radius-sm);
        padding: 20px;
        margin-top: 20px;
    }
    
    .tamanhos-grid-horizontal {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    
    .tamanho-item-horizontal {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 80px;
    }
    
    .tamanho-label {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 8px;
        font-size: 0.875rem;
        text-align: center;
    }
    
    .tamanho-input {
        width: 70px;
        padding: 8px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        text-align: center;
        font-size: 0.875rem;
        background: white;
    }
    
    .tamanho-input:focus {
        border-color: var(--primary-blue-light);
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    
    .quantidade-resumo {
        border-top: 1px solid var(--gray-200);
        padding-top: 20px;
    }
    
    /* Departamento Header */
    .departamento-header {
        background: var(--primary-blue-light);
        color: white;
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
    }
    
    .departamento-header i {
        font-size: 1.1rem;
    }
    
    /* Tabela de Matérias-Primas */
    .materias-primas-table {
        overflow-x: auto;
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--gray-200);
    }
    
    .materias-primas-table table {
        margin: 0;
        width: 100%;
        background: white;
    }
    
    .materias-primas-table thead {
        background: var(--gray-100);
    }
    
    .materias-primas-table th {
        padding: 12px;
        font-weight: 600;
        color: var(--gray-700);
        border-bottom: 2px solid var(--gray-200);
        font-size: 0.875rem;
        text-align: center;
    }
    
    .materias-primas-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--gray-200);
        vertical-align: middle;
    }
    
    .materias-primas-table tbody tr:hover {
        background: var(--gray-50);
    }
    
    .materia-input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        font-size: 0.8125rem;
        background: white;
    }
    
    .materia-input:focus {
        border-color: var(--primary-blue-light);
        outline: none;
    }
    
    .materia-select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        font-size: 0.8125rem;
        background: white;
    }
    
    .btn-add-materia-table {
        background: var(--primary-blue-light);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-add-materia-table:hover {
        background: var(--primary-blue-dark);
        transform: translateY(-1px);
    }
    
    .btn-remove-materia-table {
        background: #ef4444;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: var(--border-radius-sm);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-remove-materia-table:hover {
        background: #dc2626;
    }
    
    /* Remove estilos antigos */
    .tamanhos-grid,
    .tamanho-item,
    .tamanho-checkbox,
    .tamanho-header,
    .tamanho-info,
    .tamanho-codigo,
    .tamanho-descricao,
    .tamanho-tipo,
    .tamanho-precos,
    .preco-input {
        display: none !important;
    }
    
    /* Price Summary */
    .price-summary {
        background: var(--accent-blue);
        border: 1px solid var(--primary-blue-light);
        border-radius: var(--border-radius-sm);
        padding: 20px;
        margin-top: 20px;
    }
    
    .price-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .price-item:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--primary-blue-dark);
    }
    
    /* Form Actions */
    .form-actions {
        background: var(--gray-50);
        padding: 24px 28px;
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .form-grid.cols-2,
        .form-grid.cols-3,
        .form-grid.cols-4 {
            grid-template-columns: 1fr;
        }
        
        .materia-prima-item {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-card-body {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">{{ form_title }}</h1>
        <p class="page-subtitle">Preencha as informações do produto e configure suas matérias-primas</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'cadastros:produtos_listar' %}" class="btn-modern btn-modern-outline">
            <i class="fas fa-arrow-left"></i>
            Voltar para Lista
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="productForm">
    {% csrf_token %}
    
    <!-- Dados Básicos -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-info-circle"></i>
                Dados Básicos
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-grid cols-3">
                <div class="form-group">
                    <label class="form-label required">Código</label>
                    <input type="text" name="codigo" class="form-control" 
                           value="{{ form.codigo.value|default:'' }}" 
                           placeholder="Ex: CALC001" required>
                    {% if form.codigo.errors %}
                        <div class="error-message">{{ form.codigo.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Referência</label>
                    <input type="text" name="referencia" class="form-control" 
                           value="{{ form.referencia.value|default:'' }}" 
                           placeholder="Ex: Calça Jeans Slim" required>
                    {% if form.referencia.errors %}
                        <div class="error-message">{{ form.referencia.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Tipo de Produto</label>
                    <select name="produto" class="form-control" required>
                        <option value="">Selecione o tipo</option>
                        {% for value, label in form.produto.field.choices %}
                            <option value="{{ value }}" {% if form.produto.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.produto.errors %}
                        <div class="error-message">{{ form.produto.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Descrição</label>
                    <textarea name="descricao" class="form-control" 
                              placeholder="Descrição detalhada do produto">{{ form.descricao.value|default:'' }}</textarea>
                    {% if form.descricao.errors %}
                        <div class="error-message">{{ form.descricao.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Características -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-palette"></i>
                Características
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-grid cols-3">
                <div class="form-group">
                    <label class="form-label">Código da Cor</label>
                    <input type="text" name="codigo_cor" class="form-control" 
                           value="{{ form.codigo_cor.value|default:'' }}" 
                           placeholder="Ex: AZU001">
                    {% if form.codigo_cor.errors %}
                        <div class="error-message">{{ form.codigo_cor.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nome da Cor</label>
                    <input type="text" name="cor" class="form-control" 
                           value="{{ form.cor.value|default:'' }}" 
                           placeholder="Ex: Azul Marinho">
                    {% if form.cor.errors %}
                        <div class="error-message">{{ form.cor.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Unidade</label>
                    <select name="unidade" class="form-control">
                        {% for value, label in form.unidade.field.choices %}
                            <option value="{{ value }}" {% if form.unidade.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if form.unidade.errors %}
                        <div class="error-message">{{ form.unidade.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Preços -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-dollar-sign"></i>
                Preços e Custos
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-grid cols-2">
                <div class="form-group">
                    <label class="form-label">Preço de Custo</label>
                    <input type="number" name="preco_custo" class="form-control" step="0.01" min="0"
                           value="{{ form.preco_custo.value|default:'' }}" 
                           placeholder="0,00" id="precoCusto">
                    <div class="form-help">Custo para produzir o produto</div>
                    {% if form.preco_custo.errors %}
                        <div class="error-message">{{ form.preco_custo.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Preço de Venda</label>
                    <input type="number" name="preco_venda" class="form-control" step="0.01" min="0"
                           value="{{ form.preco_venda.value|default:'' }}" 
                           placeholder="0,00" id="precoVenda">
                    <div class="form-help">Preço de venda do produto</div>
                    {% if form.preco_venda.errors %}
                        <div class="error-message">{{ form.preco_venda.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Resumo de Preços -->
            <div class="price-summary" id="priceSummary" style="display: none;">
                <div class="price-item">
                    <span>Custo Base:</span>
                    <span id="custoBase">R$ 0,00</span>
                </div>
                <div class="price-item">
                    <span>Custo Matérias-Primas:</span>
                    <span id="custoMaterias">R$ 0,00</span>
                </div>
                <div class="price-item">
                    <span>Custo Total:</span>
                    <span id="custoTotal">R$ 0,00</span>
                </div>
                <div class="price-item">
                    <span>Margem de Lucro:</span>
                    <span id="margemLucro">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Consumo de Linhas -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-tape"></i>
                Consumo de Linhas
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-grid cols-3">
                <div class="form-group">
                    <label class="form-label">Linha Externa (metros)</label>
                    <input type="number" name="consumo_linha_externa" class="form-control" step="0.01" min="0"
                           value="{{ form.consumo_linha_externa.value|default:'' }}" 
                           placeholder="0,00">
                    {% if form.consumo_linha_externa.errors %}
                        <div class="error-message">{{ form.consumo_linha_externa.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Linha Interna (metros)</label>
                    <input type="number" name="consumo_linha_interna" class="form-control" step="0.01" min="0"
                           value="{{ form.consumo_linha_interna.value|default:'' }}" 
                           placeholder="0,00">
                    {% if form.consumo_linha_interna.errors %}
                        <div class="error-message">{{ form.consumo_linha_interna.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fio (metros)</label>
                    <input type="number" name="consumo_fio" class="form-control" step="0.01" min="0"
                           value="{{ form.consumo_fio.value|default:'' }}" 
                           placeholder="0,00">
                    {% if form.consumo_fio.errors %}
                        <div class="error-message">{{ form.consumo_fio.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Matérias-Primas (NOVA SEÇÃO) -->
    <div class="form-card" style="display: none;">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-industry"></i>
                Matérias-Primas (Opcional)
            </h3>
        </div>
        <div class="form-card-body">
            <p class="text-sm text-gray-600 mb-4">
                Configure as matérias-primas utilizadas neste produto. Isso ajudará no cálculo do custo total.
            </p>
            
            <div class="materias-primas-section">
                <div id="materiasPrimasContainer">
                    <!-- Matérias-primas serão adicionadas aqui via JavaScript -->
                </div>
                
                <button type="button" class="btn-add-materia" onclick="addMateriaPrima()">
                    <i class="fas fa-plus"></i>
                    Adicionar Matéria-Prima
                </button>
            </div>
        </div>
    </div>

    <!-- Tamanhos Disponíveis (NOVA SEÇÃO) -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-ruler-combined"></i>
                Quantidades por Tamanho
            </h3>
        </div>
        <div class="form-card-body">
            <p class="text-sm text-gray-600 mb-4">
                Configure as quantidades disponíveis para cada tamanho do produto.
            </p>
            
            <div class="tamanhos-section">
                <div class="tamanhos-grid-horizontal" id="tamanhosGridHorizontal">
                    <!-- Tamanhos serão carregados aqui via JavaScript -->
                </div>
                
                <div class="quantidade-resumo mt-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Quantidade Total</label>
                                <input type="number" id="quantidadeTotal" class="form-control" readonly placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Valor Total (R$)</label>
                                <input type="text" id="valorTotal" class="form-control" readonly placeholder="R$ 0,00">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tamanhos-actions mt-3">
                    <button type="button" class="btn-modern btn-modern-outline btn-modern-sm" onclick="zerarTodosTamanhos()">
                        <i class="fas fa-eraser"></i>
                        Zerar Todos
                    </button>
                    <button type="button" class="btn-modern btn-modern-secondary btn-modern-sm" onclick="gerenciarTamanhos()">
                        <i class="fas fa-cog"></i>
                        Gerenciar Tamanhos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Necessidade de Matéria Prima (NOVA SEÇÃO) -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-industry"></i>
                Necessidade de Matéria Prima
            </h3>
        </div>
        <div class="form-card-body">
            
            <!-- Departamento Header -->
            <div class="departamento-header">
                <i class="fas fa-tag"></i>
                <span>Departamento: AVIAMENTOS</span>
            </div>
            
            <!-- Tabela de Matérias-Primas -->
            <div class="materias-primas-table">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th width="15%">Código</th>
                            <th width="25%">Descrição</th>
                            <th width="15%">Unidade</th>
                            <th width="15%">Consumo Unit.</th>
                            <th width="15%">Qtd. Necessária</th>
                            <th width="10%">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="materiasPrimasTableBody">
                        <!-- Matérias-primas serão adicionadas aqui -->
                    </tbody>
                </table>
            </div>
            
            <!-- Botão Adicionar -->
            <div class="mt-3">
                <button type="button" class="btn-add-materia-table" onclick="adicionarMateriaPrima()">
                    <i class="fas fa-plus"></i>
                    Adicionar Item de Matéria Prima
                </button>
            </div>
        </div>
    </div>

    <!-- Imagem -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-image"></i>
                Imagem do Produto
            </h3>
        </div>
        <div class="form-card-body">
            <div class="image-upload-area" onclick="document.getElementById('id_imagem').click()">
                {% if form.imagem.value %}
                    <img src="{{ form.imagem.value.url }}" alt="Produto" class="image-preview" id="imagePreview">
                {% else %}
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p><strong>Clique para selecionar uma imagem</strong></p>
                    <p class="text-sm text-gray-500">PNG, JPG até 5MB</p>
                {% endif %}
            </div>
            <input type="file" name="imagem" id="id_imagem" accept="image/*" style="display: none;" onchange="previewImage(this)">
            {% if form.imagem.errors %}
                <div class="error-message">{{ form.imagem.errors.0 }}</div>
            {% endif %}
        </div>
    </div>

    <!-- Configurações -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-cog"></i>
                Configurações
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" name="ativo" {% if form.ativo.value %}checked{% endif %} style="margin-right: 8px;">
                    Produto ativo
                </label>
                <div class="form-help">Produtos inativos não aparecerão nas listagens</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Observações</label>
                <textarea name="observacoes" class="form-control" rows="3"
                          placeholder="Observações adicionais sobre o produto">{{ form.observacoes.value|default:'' }}</textarea>
                {% if form.observacoes.errors %}
                    <div class="error-message">{{ form.observacoes.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="form-actions">
        <a href="{% url 'cadastros:produtos_listar' %}" class="btn-modern btn-modern-outline">
            <i class="fas fa-times"></i>
            Cancelar
        </a>
        <button type="submit" class="btn-modern btn-modern-primary">
            <i class="fas fa-save"></i>
            Salvar Produto
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let materiasPrimasCount = 0;

// Preview de imagem
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const uploadArea = input.parentElement;
            uploadArea.innerHTML = `<img src="${e.target.result}" alt="Preview" class="image-preview" id="imagePreview">`;
            uploadArea.classList.add('has-image');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Adicionar matéria-prima
function addMateriaPrima() {
    materiasPrimasCount++;
    const container = document.getElementById('materiasPrimasContainer');
    
    const materiaItem = document.createElement('div');
    materiaItem.className = 'materia-prima-item';
    materiaItem.innerHTML = `
        <div class="form-group">
            <label class="form-label">Matéria-Prima</label>
            <select name="materia_prima_${materiasPrimasCount}" class="form-control">
                <option value="">Selecione uma matéria-prima</option>
                <!-- Opções serão carregadas via AJAX -->
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Quantidade</label>
            <input type="number" name="quantidade_${materiasPrimasCount}" class="form-control materia-quantidade" 
                   step="0.0001" min="0" placeholder="0,0000" onchange="calculateCosts()">
        </div>
        <div class="form-group">
            <label class="form-label">Custo Unit.</label>
            <input type="text" class="form-control materia-custo" readonly placeholder="R$ 0,00">
        </div>
        <div class="form-group">
            <button type="button" class="btn-remove-materia" onclick="removeMateriaPrima(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(materiaItem);
    loadMateriasPrimas(materiaItem.querySelector('select'));
}

// Remover matéria-prima
function removeMateriaPrima(button) {
    button.closest('.materia-prima-item').remove();
    calculateCosts();
}

// Carregar matérias-primas via AJAX
function loadMateriasPrimas(selectElement) {
    // Simulação - em produção, fazer chamada AJAX
    const materiasPrimas = [
        {id: 1, nome: 'Tecido Jeans - Azul', preco: 25.50},
        {id: 2, nome: 'Linha de Costura - Azul', preco: 8.90},
        {id: 3, nome: 'Botão Jeans', preco: 0.75},
        {id: 4, nome: 'Zíper 15cm', preco: 3.20}
    ];
    
    materiasPrimas.forEach(materia => {
        const option = document.createElement('option');
        option.value = materia.id;
        option.textContent = `${materia.nome} - R$ ${materia.preco.toFixed(2)}`;
        option.dataset.preco = materia.preco;
        selectElement.appendChild(option);
    });
    
    selectElement.addEventListener('change', function() {
        const custoInput = this.closest('.materia-prima-item').querySelector('.materia-custo');
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.preco) {
            custoInput.value = `R$ ${parseFloat(selectedOption.dataset.preco).toFixed(2)}`;
        } else {
            custoInput.value = 'R$ 0,00';
        }
        calculateCosts();
    });
}

// Calcular custos
function calculateCosts() {
    const precoCusto = parseFloat(document.getElementById('precoCusto').value) || 0;
    const precoVenda = parseFloat(document.getElementById('precoVenda').value) || 0;
    
    let custoMaterias = 0;
    document.querySelectorAll('.materia-prima-item').forEach(item => {
        const select = item.querySelector('select');
        const quantidade = parseFloat(item.querySelector('.materia-quantidade').value) || 0;
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption && selectedOption.dataset.preco) {
            const precoUnitario = parseFloat(selectedOption.dataset.preco);
            custoMaterias += quantidade * precoUnitario;
        }
    });
    
    const custoTotal = precoCusto + custoMaterias;
    const margemLucro = precoVenda > 0 ? ((precoVenda - custoTotal) / precoVenda * 100) : 0;
    
    // Atualizar resumo
    document.getElementById('custoBase').textContent = `R$ ${precoCusto.toFixed(2)}`;
    document.getElementById('custoMaterias').textContent = `R$ ${custoMaterias.toFixed(2)}`;
    document.getElementById('custoTotal').textContent = `R$ ${custoTotal.toFixed(2)}`;
    document.getElementById('margemLucro').textContent = `${margemLucro.toFixed(1)}%`;
    
    // Mostrar/ocultar resumo
    const summary = document.getElementById('priceSummary');
    if (precoCusto > 0 || precoVenda > 0 || custoMaterias > 0) {
        summary.style.display = 'block';
    } else {
        summary.style.display = 'none';
    }
}

// Event listeners para cálculo automático
document.addEventListener('DOMContentLoaded', function() {
    carregarTamanhos();
    
    // Event listeners para cálculo automático
    const precoCustoEl = document.getElementById('precoCusto');
    const precoVendaEl = document.getElementById('precoVenda');
    
    if (precoCustoEl) {
        precoCustoEl.addEventListener('input', calculateCosts);
        precoCustoEl.addEventListener('input', calcularTotais);
    }
    
    if (precoVendaEl) {
        precoVendaEl.addEventListener('input', calculateCosts);
        precoVendaEl.addEventListener('input', calcularTotais);
    }
    
    // Inicializar cálculos
    calculateCosts();
    calcularTotais();
    
    // Adicionar uma linha de matéria-prima como exemplo
    adicionarMateriaPrima();
});

// Carrega tamanhos disponíveis no formato horizontal
function carregarTamanhos() {
    // Simular dados - em produção fazer chamada AJAX
    const tamanhos = [
        { id: 1, codigo: 'PP', descricao: 'Extra Pequeno' },
        { id: 2, codigo: 'P', descricao: 'Pequeno' },
        { id: 3, codigo: 'M', descricao: 'Médio' },
        { id: 4, codigo: 'G', descricao: 'Grande' },
        { id: 5, codigo: 'GG', descricao: 'Extra Grande' },
        { id: 6, codigo: 'XGG', descricao: 'Extra Extra Grande' }
    ];
    
    const grid = document.getElementById('tamanhosGridHorizontal');
    grid.innerHTML = '';
    
    tamanhos.forEach(tamanho => {
        const item = document.createElement('div');
        item.className = 'tamanho-item-horizontal';
        
        item.innerHTML = `
            <div class="tamanho-label">${tamanho.codigo}</div>
            <input type="number" 
                   class="tamanho-input" 
                   name="quantidade_${tamanho.codigo.toLowerCase()}"
                   placeholder="0"
                   min="0"
                   onchange="calcularTotais()"
                   data-tamanho="${tamanho.codigo}">
        `;
        
        grid.appendChild(item);
    });
}

// Zera todos os tamanhos
function zerarTodosTamanhos() {
    const inputs = document.querySelectorAll('.tamanho-input');
    inputs.forEach(input => {
        input.value = '';
    });
    calcularTotais();
}

// Calcula totais de quantidade e valor
function calcularTotais() {
    const inputs = document.querySelectorAll('.tamanho-input');
    let quantidadeTotal = 0;
    
    inputs.forEach(input => {
        const valor = parseInt(input.value) || 0;
        quantidadeTotal += valor;
    });
    
    // Atualizar campos de resumo
    document.getElementById('quantidadeTotal').value = quantidadeTotal;
    
    // Calcular valor total (quantidade × preço de venda)
    const precoVenda = parseFloat(document.getElementById('precoVenda').value) || 0;
    const valorTotal = quantidadeTotal * precoVenda;
    
    document.getElementById('valorTotal').value = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
    
    // Recalcular necessidades de matérias-primas
    calcularTodasNecessidades();
}

// Adicionar linha de matéria-prima na tabela
function adicionarMateriaPrima() {
    materiasPrimasCount++;
    const tbody = document.getElementById('materiasPrimasTableBody');
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <input type="text" 
                   class="materia-input" 
                   name="materia_codigo_${materiasPrimasCount}"
                   placeholder="Ex: 1010000">
        </td>
        <td>
            <input type="text" 
                   class="materia-input" 
                   name="materia_descricao_${materiasPrimasCount}"
                   placeholder="Ex: Velcro 20mm">
        </td>
        <td>
            <select class="materia-select" name="materia_unidade_${materiasPrimasCount}">
                <option value="PEÇA">PEÇA</option>
                <option value="METRO">METRO</option>
                <option value="KG">KG</option>
                <option value="UNIDADE">UNIDADE</option>
            </select>
        </td>
        <td>
            <input type="number" 
                   class="materia-input" 
                   name="materia_consumo_${materiasPrimasCount}"
                   placeholder="0,00"
                   step="0.01"
                   onchange="calcularNecessidadeMateria(this)">
        </td>
        <td>
            <input type="number" 
                   class="materia-input necessidade-field" 
                   name="materia_necessidade_${materiasPrimasCount}"
                   placeholder="0"
                   readonly>
        </td>
        <td style="text-align: center;">
            <button type="button" 
                    class="btn-remove-materia-table" 
                    onclick="removerMateriaPrima(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
}

// Remover linha de matéria-prima
function removerMateriaPrima(button) {
    const row = button.closest('tr');
    row.remove();
    calcularTodasNecessidades();
}

// Calcular necessidade de uma matéria-prima específica
function calcularNecessidadeMateria(input) {
    const row = input.closest('tr');
    const consumoInput = row.querySelector('input[name*="consumo"]');
    const necessidadeInput = row.querySelector('input[name*="necessidade"]');
    
    const consumoUnitario = parseFloat(consumoInput.value) || 0;
    const quantidadeTotal = parseInt(document.getElementById('quantidadeTotal').value) || 0;
    
    const necessidade = consumoUnitario * quantidadeTotal;
    necessidadeInput.value = necessidade.toFixed(2);
}

// Recalcular todas as necessidades quando a quantidade total mudar
function calcularTodasNecessidades() {
    const consumoInputs = document.querySelectorAll('input[name*="consumo"]');
    consumoInputs.forEach(input => {
        if (input.value) {
            calcularNecessidadeMateria(input);
        }
    });
}

// Gerenciar tamanhos (abre modal ou nova página)
function gerenciarTamanhos() {
    alert('Funcionalidade de gerenciamento de tamanhos será implementada em breve.');
}
</script>
{% endblock %} 
{% extends 'base/dashboard_base.html' %}
{% load currency_filters %}

{% block title %}{{ form_title|default:"Produto" }} - {{ empresa.nome }} - Costurai.com.br{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .form-card-header {
        padding: 24px 28px 20px;
        border-bottom: 1px solid var(--gray-200);
        background: white;
    }
    
    .form-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-card-title i {
        color: var(--primary-blue-light);
    }
    
    .form-card-body {
        padding: 28px;
    }
    
    .form-grid {
        display: grid;
        gap: 20px;
    }
    
    .form-grid.cols-2 {
        grid-template-columns: 1fr 1fr;
    }
    
    .form-grid.cols-3 {
        grid-template-columns: 1fr 1fr 1fr;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 6px;
    }
    
    .form-label.required:after {
        content: ' *';
        color: var(--danger);
    }
    
    .form-control {
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        padding: 12px 14px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
    }
    
    .form-control:focus {
        border-color: var(--primary-blue-light);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .form-control:read-only {
        background: var(--gray-50);
        color: var(--gray-600);
    }
    
    .form-control.error {
        border-color: var(--danger);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }
    
    .form-help {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 4px;
    }
    
    .error-message {
        background: var(--danger-light);
        color: var(--danger);
        padding: 8px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.8125rem;
        margin-top: 4px;
        border: 1px solid #fecaca;
    }
    
    /* Input Groups */
    .input-group {
        display: flex;
        align-items: stretch;
        gap: 0;
    }
    
    .input-group .form-control {
        flex: 1;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .btn-add-item {
        background: var(--primary-blue-light);
        color: white;
        border: 1px solid var(--primary-blue-light);
        border-left: none;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-top-right-radius: var(--border-radius-sm);
        border-bottom-right-radius: var(--border-radius-sm);
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
    }
    
    .btn-add-item:hover {
        background: var(--primary-blue-dark);
        border-color: var(--primary-blue-dark);
        transform: translateY(-1px);
    }
    
    .btn-generate-code {
        background: var(--success);
        color: white;
        border: 1px solid var(--success);
        border-left: none;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-top-right-radius: var(--border-radius-sm);
        border-bottom-right-radius: var(--border-radius-sm);
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
    }
    
    .btn-generate-code:hover {
        background: #059669;
        border-color: #059669;
        transform: translateY(-1px);
    }
    
    .codigo-automatico {
        background: var(--accent-blue) !important;
        border-color: var(--primary-blue-light) !important;
    }
    
    .image-upload-area {
        border: 2px dashed var(--gray-300);
        border-radius: var(--border-radius-sm);
        padding: 32px;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .image-upload-area:hover {
        border-color: var(--primary-blue-light);
        background: var(--accent-blue);
    }
    
    .image-upload-area.has-image {
        border-style: solid;
        border-color: var(--success);
        background: var(--success-light);
    }
    
    .upload-icon {
        font-size: 2rem;
        color: var(--gray-400);
        margin-bottom: 12px;
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: var(--border-radius-sm);
        margin: 12px auto;
        display: block;
        border: 1px solid var(--gray-200);
    }
    
    .form-actions {
        background: var(--gray-50);
        padding: 24px 28px;
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .modal-close:hover {
        background: var(--gray-100);
        color: var(--gray-600);
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    
    .modal-form .form-group {
        margin-bottom: 16px;
    }
    
    .modal-form .form-control {
        width: 100%;
    }
    
    /* Grade Feedback Styles */
    .grade-feedback {
        background: var(--accent-blue);
        border: 1px solid var(--primary-blue-light);
        border-radius: var(--border-radius-sm);
        padding: 20px;
        margin-top: 16px;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .feedback-header {
        margin-bottom: 16px;
    }
    
    .feedback-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-blue-dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .feedback-title i {
        color: var(--primary-blue-light);
    }
    
    .feedback-description {
        color: var(--gray-700);
        font-size: 0.875rem;
        margin-bottom: 16px;
        line-height: 1.5;
    }
    
    .feedback-examples {
        margin-bottom: 16px;
    }
    
    .examples-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 8px;
    }
    
    .examples-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .example-tag {
        background: var(--primary-blue-light);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 500;
        display: inline-block;
    }
    
    .example-tag.numeros {
        background: #059669; /* Verde para números */
    }
    
    .example-tag.letras {
        background: #dc2626; /* Vermelho para letras */
    }
    
    .example-tag.idade {
        background: #7c3aed; /* Roxo para idade */
    }
    
    .example-tag.personalizado {
        background: var(--gray-500); /* Cinza para personalizado */
    }
    
    .feedback-custom {
        background: var(--warning-light);
        border: 1px solid var(--warning);
        border-radius: var(--border-radius-sm);
        padding: 12px;
    }
    
    .custom-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        color: var(--gray-700);
    }
    
    .custom-info i {
        color: var(--warning);
    }
    
    /* Matérias-Primas Styles */
    .form-help-section {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-bottom: 24px;
        padding: 12px 16px;
        background: var(--gray-50);
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--primary-blue-light);
    }
    
    .linha-materia-prima {
        margin-bottom: 20px;
    }
    
    .linha-materia-prima.template {
        display: none !important;
    }
    
    .materia-card {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        padding: 20px;
        transition: all 0.2s ease;
    }
    
    .materia-card:hover {
        border-color: var(--primary-blue-light);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    .materia-header {
        display: grid;
        grid-template-columns: 1fr 200px 60px;
        gap: 16px;
        align-items: end;
        margin-bottom: 16px;
    }
    
    .materia-select-group,
    .quantidade-group {
        display: flex;
        flex-direction: column;
    }
    
    .materia-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 6px;
    }
    
    .quantidade-input {
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        padding: 12px 14px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .quantidade-input:focus {
        border-color: var(--primary-blue-light);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .acoes-group {
        display: flex;
        justify-content: center;
        align-items: end;
    }
    
    .btn-remove-materia {
        background: var(--danger);
        color: white;
        border: 1px solid var(--danger);
        border-radius: var(--border-radius-sm);
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
        height: 44px;
    }
    
    .btn-remove-materia:hover {
        background: #dc2626;
        border-color: #dc2626;
        transform: translateY(-1px);
    }
    
    /* Feedback Visual */
    .materia-feedback {
        background: var(--accent-blue);
        border: 1px solid var(--primary-blue-light);
        border-radius: var(--border-radius-sm);
        padding: 16px;
        margin-top: 16px;
        animation: slideDown 0.3s ease;
    }
    
    .feedback-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
    }
    
    .info-item i {
        color: var(--primary-blue-light);
        width: 16px;
        text-align: center;
    }
    
    .info-label {
        color: var(--gray-600);
        font-weight: 500;
    }
    
    .info-value {
        color: var(--gray-900);
        font-weight: 600;
    }
    
    .estoque-status {
        display: flex;
        justify-content: flex-end;
    }
    
    .status-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 500;
    }
    
    .status-badge.status-normal {
        background: var(--success-light);
        color: var(--success);
        border: 1px solid var(--success);
    }
    
    .status-badge.status-baixo {
        background: var(--warning-light);
        color: var(--warning);
        border: 1px solid var(--warning);
    }
    
    .status-badge.status-zerado {
        background: var(--danger-light);
        color: var(--danger);
        border: 1px solid var(--danger);
    }
    
    .status-badge.status-alto {
        background: var(--info-light);
        color: var(--info);
        border: 1px solid var(--info);
    }
    
    /* Botão Adicionar */
    .add-materia-section {
        margin: 24px 0;
        text-align: center;
    }
    
    .btn-add-materia {
        background: var(--primary-blue-light);
        color: white;
        border: 2px dashed var(--primary-blue-light);
        border-radius: var(--border-radius-sm);
        padding: 16px 24px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-add-materia:hover {
        background: var(--primary-blue-dark);
        border-color: var(--primary-blue-dark);
        transform: translateY(-1px);
    }
    
    /* Resumo de Custos */
    .resumo-custos {
        background: linear-gradient(135deg, var(--success-light), var(--accent-blue));
        border: 1px solid var(--success);
        border-radius: var(--border-radius);
        padding: 24px;
        margin-top: 24px;
        animation: slideDown 0.3s ease;
    }
    
    .resumo-header {
        margin-bottom: 16px;
    }
    
    .resumo-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--success);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .resumo-content {
        margin-bottom: 16px;
    }
    
    .custo-linha,
    .margem-linha {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .custo-linha:last-child,
    .margem-linha:last-child {
        border-bottom: none;
    }
    
    .custo-label,
    .margem-label {
        font-size: 0.875rem;
        color: var(--gray-700);
        font-weight: 500;
    }
    
    .custo-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--success);
    }
    
    .margem-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-800);
    }
    
    .resumo-footer {
        padding-top: 12px;
        border-top: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .resumo-help {
        color: var(--gray-600);
        font-size: 0.8125rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .resumo-help i {
        color: var(--success);
    }
    
    @media (max-width: 768px) {
        .form-grid.cols-2,
        .form-grid.cols-3 {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-card-body {
            padding: 20px;
        }
        
        .examples-list {
            justify-content: center;
        }
        
        .materia-header {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .feedback-info {
            grid-template-columns: 1fr;
        }
        
        .estoque-status {
            justify-content: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            {% if object %}
                Editar Produto: {{ object.codigo }}
            {% else %}
                Novo Produto
            {% endif %}
        </h1>
        <p class="page-subtitle">Configure as informações do produto</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'cadastros:produtos_listar' %}" class="btn-modern btn-modern-outline">
            <i class="fas fa-arrow-left"></i>
            Voltar para Lista
        </a>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="productForm">
    {% csrf_token %}
    
    <!-- Dados Básicos -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-info-circle"></i>
                Dados Básicos
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-grid cols-2">
                <div class="form-group">
                    <label class="form-label required">Código</label>
                    <div class="input-group">
                        <input type="text" name="codigo" id="codigo_input" class="form-control" 
                               value="{{ form.codigo.value|default:'' }}" 
                               placeholder="Será gerado automaticamente" required>
                        <button type="button" class="btn-generate-code" onclick="gerarCodigoAutomatico()" title="Gerar código automático">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                    <div class="form-help">Código único do produto. Deixe vazio para gerar automaticamente.</div>
                    {% if form.codigo.errors %}
                        <div class="error-message">{{ form.codigo.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Produto</label>
                    <div class="input-group">
                        {{ form.tipo_produto }}
                        <button type="button" class="btn-add-item" onclick="openTipoProdutoModal()" title="Adicionar novo tipo">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    {% if form.tipo_produto.errors %}
                        <div class="error-message">{{ form.tipo_produto.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <div class="input-group">
                        {{ form.categoria }}
                        <button type="button" class="btn-add-item" onclick="openCategoriaModal()" title="Adicionar nova categoria">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    {% if form.categoria.errors %}
                        <div class="error-message">{{ form.categoria.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">NCM</label>
                    <div class="input-group">
                        {{ form.ncm }}
                        <button type="button" class="btn-add-item" onclick="openNCMModal()" title="Adicionar novo NCM">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="form-help">Classificação fiscal do produto</div>
                    {% if form.ncm.errors %}
                        <div class="error-message">{{ form.ncm.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label required">Descrição</label>
                    {{ form.descricao }}
                    {% if form.descricao.errors %}
                        <div class="error-message">{{ form.descricao.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema de Grades -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-ruler-combined"></i>
                Sistema de Grades
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-group">
                <label class="form-label">Tipo de Grade</label>
                {{ form.tipo_grade }}
                <div class="form-help">Define como serão os tamanhos deste produto (PP/P/M/G, 36/38/40, 2/4/6 anos, etc.)</div>
                {% if form.tipo_grade.errors %}
                    <div class="error-message">{{ form.tipo_grade.errors.0 }}</div>
                {% endif %}
            </div>
            
            <!-- Feedback Visual do Tipo de Grade -->
            <div id="grade-feedback" class="grade-feedback" style="display: none;">
                <div class="feedback-header">
                    <h4 class="feedback-title">
                        <i class="fas fa-info-circle"></i>
                        <span id="feedback-title-text">Tamanhos Disponíveis</span>
                    </h4>
                </div>
                <div class="feedback-content">
                    <div id="feedback-description" class="feedback-description"></div>
                    <div id="feedback-examples" class="feedback-examples">
                        <div class="examples-label">Exemplos de tamanhos:</div>
                        <div id="examples-list" class="examples-list"></div>
                    </div>
                    <div id="feedback-custom" class="feedback-custom" style="display: none;">
                        <div class="custom-info">
                            <i class="fas fa-cog"></i>
                            <span>Para tipos personalizados, configure os tamanhos específicos no módulo de Estoque → Tamanhos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preços -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-dollar-sign"></i>
                Preços e Custos
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-grid cols-2">
                <div class="form-group">
                    <label class="form-label">Preço de Custo</label>
                    {{ form.preco_custo }}
                    <div class="form-help">Custo para produzir o produto</div>
                    {% if form.preco_custo.errors %}
                        <div class="error-message">{{ form.preco_custo.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Preço de Venda</label>
                    {{ form.preco_venda }}
                    <div class="form-help">Preço de venda do produto</div>
                    {% if form.preco_venda.errors %}
                        <div class="error-message">{{ form.preco_venda.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Matérias-Primas -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-industry"></i>
                Ficha Técnica - Matérias-Primas
            </h3>
        </div>
        <div class="form-card-body">
            <p class="form-help-section">
                Configure as matérias-primas utilizadas neste produto para cálculo automático do custo.
            </p>
            
            <!-- Container das Matérias-Primas -->
            <div id="materias-primas-container">
                {{ materias_primas.management_form }}
                
                <!-- Linha Template (oculta) -->
                <div id="linha-template" class="linha-materia-prima template" style="display: none;">
                    <div class="materia-card">
                        <div class="materia-header">
                            <div class="materia-select-group">
                                <label class="materia-label">Matéria-Prima</label>
                                <div class="input-group">
                                    <select class="form-control materia-select" name="__prefix__-materia_prima" required>
                                        <option value="">Selecione uma matéria-prima...</option>
                                        {% for materia in form.fields.materia_prima.queryset %}
                                            <option value="{{ materia.id }}">{{ materia.codigo }} - {{ materia.descricao }}</option>
                                        {% endfor %}
                                    </select>
                                    <a href="{% url 'estoque:materia_prima_create' %}" target="_blank" class="btn-add-item" title="Cadastrar nova matéria-prima" style="text-decoration: none;">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </div>
                            
                            <div class="quantidade-group">
                                <label class="materia-label">Quantidade</label>
                                <input type="number" class="form-control quantidade-input" name="__prefix__-quantidade" 
                                       step="0.001" min="0" placeholder="0,000" required>
                            </div>
                            
                            <div class="acoes-group">
                                <button type="button" class="btn-remove-materia" onclick="removerLinhaMateria(this)" title="Remover matéria-prima">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Feedback Visual da Matéria-Prima -->
                        <div class="materia-feedback" style="display: none;">
                            <div class="feedback-info">
                                <div class="info-item">
                                    <i class="fas fa-cube"></i>
                                    <span class="info-label">Unidade:</span>
                                    <span class="info-value unidade-value">-</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span class="info-label">Última compra:</span>
                                    <span class="info-value preco-value">R$ 0,00</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calculator"></i>
                                    <span class="info-label">Custo total:</span>
                                    <span class="info-value custo-total-value">R$ 0,00</span>
                                </div>
                            </div>
                            <div class="estoque-status">
                                <span class="status-badge status-normal">
                                    <i class="fas fa-check-circle"></i>
                                    <span class="status-text">Estoque Normal</span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Hidden fields for formset -->
                        <input type="hidden" name="__prefix__-id" value="">
                        <input type="hidden" name="__prefix__-produto" value="">
                        <input type="hidden" name="__prefix__-DELETE" value="">
                    </div>
                </div>
                
                <!-- Linhas Existentes -->
                <div id="linhas-existentes">
                    {% for form_item in materias_primas %}
                        <div class="linha-materia-prima" data-form-index="{{ forloop.counter0 }}">
                            <div class="materia-card">
                                <div class="materia-header">
                                    <div class="materia-select-group">
                                        <label class="materia-label">Matéria-Prima</label>
                                        <div class="input-group">
                                            {{ form_item.materia_prima }}
                                            <a href="{% url 'estoque:materia_prima_create' %}" target="_blank" class="btn-add-item" title="Cadastrar nova matéria-prima" style="text-decoration: none;">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="quantidade-group">
                                        <label class="materia-label">Quantidade</label>
                                        {{ form_item.quantidade }}
                                    </div>
                                    
                                    <div class="acoes-group">
                                        {% if form_item.instance.pk %}
                                            {{ form_item.DELETE }}
                                            <label for="{{ form_item.DELETE.id_for_label }}" class="btn-remove-materia" title="Remover matéria-prima">
                                                <i class="fas fa-trash"></i>
                                            </label>
                                        {% else %}
                                            <button type="button" class="btn-remove-materia" onclick="removerLinhaMateria(this)" title="Remover matéria-prima">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Feedback Visual -->
                                <div class="materia-feedback" style="display: none;">
                                    <div class="feedback-info">
                                        <div class="info-item">
                                            <i class="fas fa-cube"></i>
                                            <span class="info-label">Unidade:</span>
                                            <span class="info-value unidade-value">-</span>
                                        </div>
                                        <div class="info-item">
                                            <i class="fas fa-dollar-sign"></i>
                                            <span class="info-label">Última compra:</span>
                                            <span class="info-value preco-value">R$ 0,00</span>
                                        </div>
                                        <div class="info-item">
                                            <i class="fas fa-calculator"></i>
                                            <span class="info-label">Custo total:</span>
                                            <span class="info-value custo-total-value">R$ 0,00</span>
                                        </div>
                                    </div>
                                    <div class="estoque-status">
                                        <span class="status-badge status-normal">
                                            <i class="fas fa-check-circle"></i>
                                            <span class="status-text">Estoque Normal</span>
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Hidden fields -->
                                {{ form_item.id }}
                                {{ form_item.produto }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Botão Adicionar -->
            <div class="add-materia-section">
                <button type="button" class="btn-add-materia" onclick="adicionarLinhaMateria()">
                    <i class="fas fa-plus"></i>
                    Adicionar Matéria-Prima
                </button>
            </div>
            
            <!-- Resumo de Custos -->
            <div id="resumo-custos" class="resumo-custos" style="display: none;">
                <div class="resumo-header">
                    <h4 class="resumo-title">
                        <i class="fas fa-calculator"></i>
                        Resumo de Custos
                    </h4>
                </div>
                <div class="resumo-content">
                    <div class="custo-linha">
                        <span class="custo-label">Custo Total de Matérias-Primas:</span>
                        <span class="custo-value" id="custo-total-display">R$ 0,00</span>
                    </div>
                    <div class="margem-linha">
                        <span class="margem-label">Margem 40% (sugerida):</span>
                        <span class="margem-value" id="margem-40-display">R$ 0,00</span>
                    </div>
                    <div class="margem-linha">
                        <span class="margem-label">Margem 50% (sugerida):</span>
                        <span class="margem-value" id="margem-50-display">R$ 0,00</span>
                    </div>
                </div>
                <div class="resumo-footer">
                    <small class="resumo-help">
                        <i class="fas fa-info-circle"></i>
                        Os valores de margem são sugestões. O preço de venda final deve ser definido por você.
                    </small>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal para Nova Categoria -->
    <div id="categoriaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova Categoria</h3>
                <button type="button" class="modal-close" onclick="closeCategoriaModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="categoriaForm" class="modal-form">
                    <div class="form-group">
                        <label class="form-label required">Nome da Categoria</label>
                        <input type="text" name="nome" class="form-control" placeholder="Ex: Roupas Casuais" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descrição</label>
                        <textarea name="descricao" class="form-control" rows="2" placeholder="Descrição da categoria (opcional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modern btn-modern-outline" onclick="closeCategoriaModal()">
                    Cancelar
                </button>
                <button type="button" class="btn-modern btn-modern-primary" onclick="salvarCategoria()">
                    <i class="fas fa-save"></i>
                    Salvar Categoria
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Novo NCM -->
    <div id="ncmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo NCM</h3>
                <button type="button" class="modal-close" onclick="closeNCMModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="ncmForm" class="modal-form">
                    <div class="form-group">
                        <label class="form-label required">Código NCM</label>
                        <input type="text" name="codigo" class="form-control" placeholder="Ex: 6203.42.00" required>
                        <div class="form-help">Código NCM de 8 dígitos</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Descrição</label>
                        <textarea name="descricao" class="form-control" rows="2" placeholder="Descrição do produto conforme NCM" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Alíquota IPI (%)</label>
                        <input type="number" name="aliquota_ipi" class="form-control" min="0" max="100" step="0.01" value="0" placeholder="0.00">
                        <div class="form-help">Alíquota de IPI em porcentagem</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modern btn-modern-outline" onclick="closeNCMModal()">
                    Cancelar
                </button>
                <button type="button" class="btn-modern btn-modern-primary" onclick="salvarNCM()">
                    <i class="fas fa-save"></i>
                    Salvar NCM
                </button>
            </div>
        </div>
    </div>

    <!-- Imagem -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-image"></i>
                Imagem do Produto
            </h3>
        </div>
        <div class="form-card-body">
            <div class="image-upload-area" onclick="document.getElementById('id_imagem').click()">
                {% if form.imagem.value %}
                    <img src="{{ form.imagem.value.url }}" alt="Produto" class="image-preview" id="imagePreview">
                {% else %}
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p><strong>Clique para selecionar uma imagem</strong></p>
                    <p class="text-sm text-gray-500">PNG, JPG até 5MB</p>
                {% endif %}
            </div>
            {{ form.imagem }}
            {% if form.imagem.errors %}
                <div class="error-message">{{ form.imagem.errors.0 }}</div>
            {% endif %}
        </div>
    </div>

    <!-- Configurações -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <i class="fas fa-cog"></i>
                Configurações
            </h3>
        </div>
        <div class="form-card-body">
            <div class="form-group">
                <label class="form-label">
                    {{ form.ativo }}
                    Produto ativo
                </label>
                <div class="form-help">Produtos inativos não aparecerão nas listagens</div>
                {% if form.ativo.errors %}
                    <div class="error-message">{{ form.ativo.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label">Observações</label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <div class="error-message">{{ form.observacoes.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="form-actions">
        <a href="{% url 'cadastros:produtos_listar' %}" class="btn-modern btn-modern-outline">
            <i class="fas fa-times"></i>
            Cancelar
        </a>
        <button type="submit" class="btn-modern btn-modern-primary">
            <i class="fas fa-save"></i>
            {% if object %}Atualizar{% else %}Salvar{% endif %} Produto
        </button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
// === CÓDIGO SIMPLIFICADO PARA DEBUG ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando...');
    
    // Inicializar todas as funcionalidades
    inicializarGrades();
    inicializarMateriasPrimas();
});

function inicializarGrades() {
    const tipoGradeSelect = document.querySelector('select[name="tipo_grade"]');
    
    if (tipoGradeSelect) {
        // Mostrar feedback inicial se já tem valor
        if (tipoGradeSelect.value) {
            mostrarFeedbackGrade(tipoGradeSelect.value);
        }
        
        // Event listener para mudanças
        tipoGradeSelect.addEventListener('change', function() {
            mostrarFeedbackGrade(this.value);
        });
    }
}

function inicializarMateriasPrimas() {
    console.log('Inicializando matérias-primas...');
    
    // Encontrar todas as linhas de matéria-prima
    const linhas = document.querySelectorAll('.linha-materia-prima:not(.template)');
    console.log('Linhas encontradas:', linhas.length);
    
    linhas.forEach((linha, index) => {
        console.log('Configurando linha', index);
        
        const materiaSelect = linha.querySelector('select[name*="materia_prima"]');
        const quantidadeInput = linha.querySelector('input[name*="quantidade"]');
        
        console.log('Elementos na linha', index, ':', {
            materiaSelect: !!materiaSelect,
            quantidadeInput: !!quantidadeInput
        });
        
        if (materiaSelect) {
            materiaSelect.addEventListener('change', function() {
                console.log('Matéria-prima selecionada:', this.value);
                buscarDadosMateriaPrima(this.value, linha);
            });
            
            // Se já tem valor, buscar dados
            if (materiaSelect.value) {
                console.log('Buscando dados iniciais para:', materiaSelect.value);
                buscarDadosMateriaPrima(materiaSelect.value, linha);
            }
        }
        
        if (quantidadeInput) {
            quantidadeInput.addEventListener('input', function() {
                console.log('Quantidade alterada:', this.value);
                calcularCustoLinha(linha);
            });
            
            quantidadeInput.addEventListener('change', function() {
                console.log('Quantidade alterada (change):', this.value);
                calcularCustoLinha(linha);
            });
        }
    });
}

async function buscarDadosMateriaPrima(materiaPrimaId, linha) {
    if (!materiaPrimaId) return;
    
    console.log('Buscando dados para matéria-prima:', materiaPrimaId);
    
    const feedbackDiv = linha.querySelector('.materia-feedback');
    if (!feedbackDiv) {
        console.log('Feedback div não encontrado');
        return;
    }
    
    // Mostrar loading
    feedbackDiv.style.display = 'block';
    feedbackDiv.innerHTML = '<div class="info-item"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
    
    try {
        const url = `{% url "cadastros:api_materia_prima_dados" 0 %}`.replace('0', materiaPrimaId);
        const response = await fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Dados recebidos:', data);
            
            if (data.success) {
                const materia = data.materia_prima;
                
                // Armazenar dados na linha
                linha.dataset.materiaPrimaData = JSON.stringify(materia);
                
                // Atualizar feedback visual
                feedbackDiv.innerHTML = `
                    <div class="feedback-info">
                        <div class="info-item">
                            <i class="fas fa-cube"></i>
                            <span class="info-label">Unidade:</span>
                            <span class="info-value">${materia.unidade_display}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span class="info-label">Última compra:</span>
                            <span class="info-value">R$ ${materia.custo_ultima_compra.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calculator"></i>
                            <span class="info-label">Custo total:</span>
                            <span class="info-value custo-total-value">R$ 0,00</span>
                        </div>
                    </div>
                    <div class="estoque-status">
                        <span class="status-badge status-${materia.status_estoque}">
                            <i class="fas fa-check-circle"></i>
                            <span class="status-text">${materia.status_estoque_display}</span>
                        </span>
                    </div>
                `;
                
                // Calcular custo se já tem quantidade
                calcularCustoLinha(linha);
                
            } else {
                feedbackDiv.innerHTML = `<div class="info-item"><i class="fas fa-exclamation-triangle"></i> Erro: ${data.error}</div>`;
            }
        }
    } catch (error) {
        console.error('Erro ao buscar dados:', error);
        feedbackDiv.innerHTML = '<div class="info-item"><i class="fas fa-exclamation-circle"></i> Erro de conexão</div>';
    }
}

function calcularCustoLinha(linha) {
    console.log('Calculando custo da linha...');
    
    const quantidadeInput = linha.querySelector('input[name*="quantidade"]');
    const custoTotalElement = linha.querySelector('.custo-total-value');
    const materiaPrimaData = linha.dataset.materiaPrimaData;
    
    if (!quantidadeInput || !custoTotalElement || !materiaPrimaData) {
        console.log('Elementos insuficientes para cálculo');
        return;
    }
    
    try {
        const materia = JSON.parse(materiaPrimaData);
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const custoUnitario = materia.custo_ultima_compra || 0;
        const custoTotal = quantidade * custoUnitario;
        
        console.log('Cálculo:', { quantidade, custoUnitario, custoTotal });
        
        custoTotalElement.textContent = `R$ ${custoTotal.toFixed(2).replace('.', ',')}`;
        
        // Calcular custo total de todas as linhas
        calcularCustoTotalGeral();
        
    } catch (error) {
        console.error('Erro no cálculo:', error);
    }
}

function calcularCustoTotalGeral() {
    console.log('Calculando custo total geral...');
    
    const linhas = document.querySelectorAll('.linha-materia-prima:not(.template)');
    let custoTotal = 0;
    
    linhas.forEach(linha => {
        const custoTotalElement = linha.querySelector('.custo-total-value');
        if (custoTotalElement && custoTotalElement.textContent) {
            const valor = custoTotalElement.textContent.replace('R$ ', '').replace(',', '.');
            const custoLinha = parseFloat(valor) || 0;
            custoTotal += custoLinha;
        }
    });
    
    console.log('Custo total calculado:', custoTotal);
    
    // Atualizar resumo se existe
    const resumoDiv = document.getElementById('resumo-custos');
    const custoTotalDisplay = document.getElementById('custo-total-display');
    
    if (custoTotal > 0) {
        if (resumoDiv) resumoDiv.style.display = 'block';
        if (custoTotalDisplay) {
            custoTotalDisplay.textContent = `R$ ${custoTotal.toFixed(2).replace('.', ',')}`;
        }
        
        // Atualizar campo preço de custo
        const precoCustoInput = document.querySelector('input[name="preco_custo"]');
        if (precoCustoInput) {
            precoCustoInput.value = custoTotal.toFixed(2);
        }
        
        // Calcular margens
        const margem40 = custoTotal / 0.6;
        const margem50 = custoTotal / 0.5;
        
        const margem40Display = document.getElementById('margem-40-display');
        const margem50Display = document.getElementById('margem-50-display');
        
        if (margem40Display) {
            margem40Display.textContent = `R$ ${margem40.toFixed(2).replace('.', ',')}`;
        }
        if (margem50Display) {
            margem50Display.textContent = `R$ ${margem50.toFixed(2).replace('.', ',')}`;
        }
    } else {
        if (resumoDiv) resumoDiv.style.display = 'none';
    }
}

// Gerar código automático
async function gerarCodigoAutomatico() {
    const codigoInput = document.getElementById('codigo_input');
    const button = document.querySelector('.btn-generate-code');
    
    // Mostrar loading
    const originalIcon = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        const response = await fetch('{% url "cadastros:gerar_codigo_produto" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            codigoInput.value = data.codigo;
            codigoInput.classList.add('codigo-automatico');
            
            // Mostrar notificação
            showNotification(`Código ${data.codigo} gerado automaticamente`, 'success');
        } else {
            throw new Error('Erro ao gerar código');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao gerar código automático', 'error');
    } finally {
        // Restaurar botão
        button.innerHTML = originalIcon;
        button.disabled = false;
    }
}

// Preview de imagem
const imagemInput = document.getElementById('id_imagem');
if (imagemInput) {
    imagemInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const uploadArea = document.querySelector('.image-upload-area');
                uploadArea.innerHTML = `<img src="${event.target.result}" alt="Preview" class="image-preview" id="imagePreview">`;
                uploadArea.classList.add('has-image');
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });
}

// Função para mostrar notificações
function showNotification(message, type = 'info') {
    console.log(`Notificação ${type}: ${message}`);
    // Implementação simples - pode ser melhorada
    alert(message);
}

// Placeholder para outras funções
function mostrarFeedbackGrade(tipoGradeId) {
    console.log('Feedback grade:', tipoGradeId);
    // Implementação do feedback de grade já existe
}

function openCategoriaModal() { console.log('Abrir modal categoria'); }
function closeCategoriaModal() { console.log('Fechar modal categoria'); }
function openNCMModal() { console.log('Abrir modal NCM'); }
function closeNCMModal() { console.log('Fechar modal NCM'); }
function openTipoProdutoModal() { console.log('Abrir modal tipo produto'); }
// === MODAL MATERIA PRIMA ===
function abrirModalMateriaPrima() {
    console.log('Abrindo modal de matéria-prima...');
    
    // Carregar categorias no select
    carregarCategoriasMateriasPrimas();
    
    // Mostrar modal
    const modal = document.getElementById('materiaPrimaModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Focar no campo descrição
    setTimeout(() => {
        const descricaoInput = document.querySelector('#materiaPrimaModal input[name="descricao"]');
        if (descricaoInput) descricaoInput.focus();
    }, 100);
}

function fecharModalMateriaPrima() {
    const modal = document.getElementById('materiaPrimaModal');
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
    
    // Limpar formulário
    document.getElementById('materiaPrimaForm').reset();
}

async function carregarCategoriasMateriasPrimas() {
    console.log('Carregando categorias de matérias-primas...');
    
    const categoriaSelect = document.querySelector('#materiaPrimaModal select[name="categoria_id"]');
    if (!categoriaSelect) return;
    
    // Limpar select
    categoriaSelect.innerHTML = '<option value="">Selecione uma categoria...</option>';
    
    // Adicionar opções básicas
    const categoriasDefault = [
        { id: '1', nome: 'Tecidos' },
        { id: '2', nome: 'Aviamentos' },
        { id: '3', nome: 'Linhas' },
        { id: '4', nome: 'Botões' },
        { id: '5', nome: 'Zíperes' }
    ];
    
    categoriasDefault.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.nome;
        categoriaSelect.appendChild(option);
    });
}

async function gerarCodigoMateriaPrima() {
    console.log('Gerando código de matéria-prima...');
    
    const codigoInput = document.querySelector('#materiaPrimaModal input[name="codigo"]');
    if (!codigoInput) return;
    
    try {
        const response = await fetch('{% url "estoque:gerar_codigo_materia_prima" %}', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        
        if (response.ok) {
            const data = await response.json();
            codigoInput.value = data.codigo;
            codigoInput.classList.add('codigo-automatico');
            console.log('Código gerado:', data.codigo);
        } else {
            throw new Error('Erro ao gerar código');
        }
    } catch (error) {
        console.error('Erro ao gerar código:', error);
        
        // Fallback: gerar código local
        const codigoFallback = gerarCodigoMateriaPrimaLocal();
        codigoInput.value = codigoFallback;
        codigoInput.classList.add('codigo-automatico');
        console.log('Código gerado localmente:', codigoFallback);
    }
}

function gerarCodigoMateriaPrimaLocal() {
    const now = new Date();
    const timestamp = now.getTime().toString().slice(-6);
    return `MP${timestamp}`;
}

async function salvarMateriaPrima() {
    console.log('Salvando matéria-prima...');
    
    const form = document.getElementById('materiaPrimaForm');
    const formData = new FormData(form);
    
    // Gerar código se estiver vazio
    const codigoInput = form.querySelector('input[name="codigo"]');
    if (!codigoInput.value.trim()) {
        await gerarCodigoMateriaPrima();
        formData.set('codigo', codigoInput.value);
    }
    
    // Adicionar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Mostrar loading
    const saveButton = document.querySelector('#materiaPrimaModal .btn-modern-primary');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    saveButton.disabled = true;
    
    try {
        const response = await fetch('{% url "cadastros:criar_materia_prima_rapida" %}', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': csrfToken }
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Matéria-prima criada:', data);
            
            if (data.success) {
                // Adicionar nova matéria-prima a todos os selects
                const materiaSelects = document.querySelectorAll('select[name*="materia_prima"]');
                materiaSelects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = data.materia_prima.id;
                    option.textContent = `${data.materia_prima.codigo} - ${data.materia_prima.descricao}`;
                    select.appendChild(option);
                });
                
                // Fechar modal
                fecharModalMateriaPrima();
                
                // Mostrar notificação
                showNotification('Matéria-prima criada com sucesso!', 'success');
                
            } else {
                showNotification(data.error || 'Erro ao criar matéria-prima', 'error');
            }
        } else {
            const errorData = await response.json();
            showNotification(errorData.error || 'Erro ao criar matéria-prima', 'error');
        }
    } catch (error) {
        console.error('Erro ao salvar matéria-prima:', error);
        showNotification('Erro ao criar matéria-prima', 'error');
    } finally {
        // Restaurar botão
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    }
}
// Gerar código automático
async function gerarCodigoAutomatico() {
    const codigoInput = document.getElementById('codigo_input');
    const button = document.querySelector('.btn-generate-code');
    
    // Mostrar loading
    const originalIcon = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        const response = await fetch('{% url "cadastros:gerar_codigo_produto" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            codigoInput.value = data.codigo;
            codigoInput.classList.add('codigo-automatico');
            
            // Mostrar notificação
            showNotification(`Código ${data.codigo} gerado automaticamente`, 'success');
        } else {
            throw new Error('Erro ao gerar código');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao gerar código automático', 'error');
    } finally {
        // Restaurar botão
        button.innerHTML = originalIcon;
        button.disabled = false;
    }
}

// Preview de imagem
document.getElementById('id_imagem').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const uploadArea = document.querySelector('.image-upload-area');
            uploadArea.innerHTML = `<img src="${event.target.result}" alt="Preview" class="image-preview" id="imagePreview">`;
            uploadArea.classList.add('has-image');
        };
        reader.readAsDataURL(e.target.files[0]);
    }
});

// === MODAL CATEGORIA ===
function openCategoriaModal() {
    document.getElementById('categoriaModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeCategoriaModal() {
    document.getElementById('categoriaModal').classList.remove('show');
    document.body.style.overflow = 'auto';
    document.getElementById('categoriaForm').reset();
}

async function salvarCategoria() {
    const form = document.getElementById('categoriaForm');
    const formData = new FormData(form);
    
    // Adicionar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    try {
        const response = await fetch('{% url "cadastros:criar_categoria_produto" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Adicionar nova categoria ao select
            const categoriaSelect = document.querySelector('select[name="categoria"]');
            const option = document.createElement('option');
            option.value = data.id;
            option.textContent = data.nome;
            option.selected = true;
            categoriaSelect.appendChild(option);
            
            // Fechar modal
            closeCategoriaModal();
            
            // Mostrar mensagem de sucesso
            showNotification('Categoria criada com sucesso!', 'success');
        } else {
            const errorData = await response.json();
            showNotification(errorData.error || 'Erro ao criar categoria', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao criar categoria', 'error');
    }
}

// === MODAL NCM ===
function openNCMModal() {
    document.getElementById('ncmModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeNCMModal() {
    document.getElementById('ncmModal').classList.remove('show');
    document.body.style.overflow = 'auto';
    document.getElementById('ncmForm').reset();
}

async function salvarNCM() {
    const form = document.getElementById('ncmForm');
    const formData = new FormData(form);
    
    // Adicionar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    try {
        const response = await fetch('{% url "cadastros:criar_ncm" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Adicionar novo NCM ao select
            const ncmSelect = document.querySelector('select[name="ncm"]');
            const option = document.createElement('option');
            option.value = data.id;
            option.textContent = data.display;
            option.selected = true;
            ncmSelect.appendChild(option);
            
            // Fechar modal
            closeNCMModal();
            
            // Mostrar mensagem de sucesso
            showNotification('NCM criado com sucesso!', 'success');
        } else {
            const errorData = await response.json();
            showNotification(errorData.error || 'Erro ao criar NCM', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao criar NCM', 'error');
    }
}

// === NOTIFICAÇÕES ===
function showNotification(message, type = 'info') {
    // Criar elemento de notificação
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="notification-close" onclick="closeNotification(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Adicionar estilos inline se não existirem
    if (!document.querySelector('#notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'notification-styles';
        styles.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1100;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                padding: 16px;
                display: flex;
                align-items: center;
                gap: 12px;
                min-width: 300px;
                animation: slideInRight 0.3s ease;
            }
            .notification-success { border-left: 4px solid #10b981; }
            .notification-error { border-left: 4px solid #ef4444; }
            .notification-info { border-left: 4px solid #3b82f6; }
            .notification-content { display: flex; align-items: center; gap: 8px; flex: 1; }
            .notification-close { background: none; border: none; cursor: pointer; padding: 4px; }
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Adicionar ao DOM
    document.body.appendChild(notification);
    
    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function closeNotification(button) {
    const notification = button.closest('.notification');
    if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
    }
}

// Gerenciar formset de matérias-primas
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-materia-prima-row');
    const formsetContainer = document.getElementById('materias-primas-formset');
    const emptyForm = document.getElementById('empty-form');
    const totalForms = document.getElementById('id_produtomateriaprima_set-TOTAL_FORMS');
    
    let formCount = parseInt(totalForms.value);
    
    addButton.addEventListener('click', function() {
        const newForm = emptyForm.innerHTML.replace(/__prefix__/g, formCount);
        const newRow = document.createElement('div');
        newRow.innerHTML = newForm;
        formsetContainer.appendChild(newRow.firstElementChild);
        
        formCount++;
        totalForms.value = formCount;
        
        // Adicionar evento de remoção
        const removeBtn = newRow.querySelector('.remove-materia-row');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                newRow.firstElementChild.remove();
                formCount--;
                totalForms.value = formCount;
            });
        }
    });
    
    // Eventos de remoção para linhas existentes
    document.querySelectorAll('.remove-materia-row').forEach(btn => {
        btn.addEventListener('click', function() {
            btn.closest('tr').remove();
            formCount--;
            totalForms.value = formCount;
        });
    });
});

// Gerar código automaticamente se campo estiver vazio
document.addEventListener('DOMContentLoaded', function() {
    const codigoField = document.getElementById('codigo_input');
    if (!codigoField.value) {
        gerarCodigoAutomatico();
    }
    
    // Detectar se usuário está digitando manualmente
    codigoField.addEventListener('input', function() {
        // Remover classe de código automático quando usuário digita
        this.classList.remove('codigo-automatico');
    });
    
    codigoField.addEventListener('focus', function() {
        // Se campo está vazio ao focar, gerar código
        if (!this.value.trim()) {
            gerarCodigoAutomatico();
        }
    });
});

// === COMPOSIÇÃO DE MATÉRIAS-PRIMAS ===
let contadorLinhas = 0;

function inicializarComposicaoMateriasPrimas() {
    // Contar linhas existentes
    const linhasExistentes = document.querySelectorAll('.linha-materia-prima:not(.template)');
    contadorLinhas = linhasExistentes.length;
    
    // Adicionar event listeners às linhas existentes
    linhasExistentes.forEach((linha, index) => {
        configurarEventListenersLinha(linha, index);
    });
    
    // Calcular custo inicial se há linhas
    if (contadorLinhas > 0) {
        calcularCustoTotal();
    }
    
    // Atualizar campo TOTAL_FORMS
    atualizarTotalForms();
}

function configurarEventListenersLinha(linha, index) {
    const materiaSelect = linha.querySelector('.materia-select');
    const quantidadeInput = linha.querySelector('.quantidade-input');
    
    if (materiaSelect) {
        materiaSelect.addEventListener('change', function() {
            mostrarFeedbackMateriaPrima(this, linha);
            calcularCustoTotal();
        });
        
        // Se já tem valor, mostrar feedback
        if (materiaSelect.value) {
            mostrarFeedbackMateriaPrima(materiaSelect, linha);
        }
    }
    
    if (quantidadeInput) {
        quantidadeInput.addEventListener('input', function() {
            atualizarCustoLinha(linha);
            calcularCustoTotal();
        });
    }
}

function adicionarLinhaMateria() {
    const container = document.getElementById('linhas-existentes');
    const template = document.getElementById('linha-template');
    
    // Clonar template
    const novaLinha = template.cloneNode(true);
    novaLinha.id = '';
    novaLinha.classList.remove('template');
    novaLinha.style.display = 'block';
    novaLinha.setAttribute('data-form-index', contadorLinhas);
    
    // Atualizar nomes dos campos
    const inputs = novaLinha.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.name) {
            input.name = input.name.replace('__prefix__', contadorLinhas);
        }
        if (input.id) {
            input.id = input.id.replace('__prefix__', contadorLinhas);
        }
    });
    
    // Adicionar ao container
    container.appendChild(novaLinha);
    
    // Configurar event listeners
    configurarEventListenersLinha(novaLinha, contadorLinhas);
    
    // Incrementar contador
    contadorLinhas++;
    
    // Atualizar total forms
    atualizarTotalForms();
    
    // Focar no select da nova linha
    const materiaSelect = novaLinha.querySelector('.materia-select');
    if (materiaSelect) {
        materiaSelect.focus();
    }
}

function removerLinhaMateria(button) {
    const linha = button.closest('.linha-materia-prima');
    
    if (linha) {
        // Verificar se é uma linha existente (com ID)
        const deleteInput = linha.querySelector('input[name$="-DELETE"]');
        if (deleteInput) {
            // Marcar para exclusão
            deleteInput.value = 'on';
            linha.style.display = 'none';
        } else {
            // Remover linha nova
            linha.remove();
        }
        
        // Recalcular custo
        calcularCustoTotal();
        
        // Atualizar total forms
        atualizarTotalForms();
    }
}

function atualizarTotalForms() {
    const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
    if (totalFormsInput) {
        const linhasVisiveis = document.querySelectorAll('.linha-materia-prima:not(.template)').length;
        totalFormsInput.value = Math.max(linhasVisiveis, contadorLinhas);
    }
}

async function mostrarFeedbackMateriaPrima(select, linha) {
    const materiaPrimaId = select.value;
    const feedbackDiv = linha.querySelector('.materia-feedback');
    
    if (!materiaPrimaId) {
        feedbackDiv.style.display = 'none';
        return;
    }
    
    // Mostrar loading
    feedbackDiv.style.display = 'block';
    feedbackDiv.innerHTML = `
        <div class="feedback-info">
            <div class="info-item">
                <i class="fas fa-spinner fa-spin"></i>
                <span class="info-label">Carregando dados...</span>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch(`{% url "cadastros:api_materia_prima_dados" 0 %}`.replace('0', materiaPrimaId), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                const materia = data.materia_prima;
                
                // Atualizar feedback visual
                feedbackDiv.innerHTML = `
                    <div class="feedback-info">
                        <div class="info-item">
                            <i class="fas fa-cube"></i>
                            <span class="info-label">Unidade:</span>
                            <span class="info-value unidade-value">${materia.unidade_display}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span class="info-label">Última compra:</span>
                            <span class="info-value preco-value">R$ ${materia.custo_ultima_compra.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calculator"></i>
                            <span class="info-label">Custo total:</span>
                            <span class="info-value custo-total-value">R$ 0,00</span>
                        </div>
                    </div>
                    <div class="estoque-status">
                        <span class="status-badge status-${materia.status_estoque}">
                            <i class="fas fa-${getStatusIcon(materia.status_estoque)}"></i>
                            <span class="status-text">${materia.status_estoque_display}</span>
                        </span>
                    </div>
                `;
                
                // Armazenar dados da matéria-prima na linha
                linha.dataset.materiaPrimaData = JSON.stringify(materia);
                
                // Atualizar custo da linha
                atualizarCustoLinha(linha);
                
            } else {
                feedbackDiv.innerHTML = `
                    <div class="feedback-info">
                        <div class="info-item">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="info-label">Erro:</span>
                            <span class="info-value">${data.error}</span>
                        </div>
                    </div>
                `;
            }
        } else {
            throw new Error('Erro na requisição');
        }
    } catch (error) {
        console.error('Erro ao buscar dados da matéria-prima:', error);
        feedbackDiv.innerHTML = `
            <div class="feedback-info">
                <div class="info-item">
                    <i class="fas fa-exclamation-circle"></i>
                    <span class="info-label">Erro de conexão</span>
                </div>
            </div>
        `;
    }
}

function getStatusIcon(status) {
    const icons = {
        'normal': 'check-circle',
        'baixo': 'exclamation-triangle',
        'zerado': 'times-circle',
        'alto': 'info-circle'
    };
    return icons[status] || 'question-circle';
}

function atualizarCustoLinha(linha) {
    const quantidadeInput = linha.querySelector('.quantidade-input');
    const custoTotalElement = linha.querySelector('.custo-total-value');
    const materiaPrimaData = linha.dataset.materiaPrimaData;
    
    if (!quantidadeInput || !custoTotalElement || !materiaPrimaData) {
        return;
    }
    
    try {
        const materia = JSON.parse(materiaPrimaData);
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const custoUnitario = materia.custo_ultima_compra || 0;
        const custoTotal = quantidade * custoUnitario;
        
        custoTotalElement.textContent = `R$ ${custoTotal.toFixed(2).replace('.', ',')}`;
        
        // Armazenar custo calculado
        linha.dataset.custoCalculado = custoTotal.toString();
        
    } catch (error) {
        console.error('Erro ao calcular custo da linha:', error);
        custoTotalElement.textContent = 'R$ 0,00';
    }
}

async function calcularCustoTotal() {
    const linhas = document.querySelectorAll('.linha-materia-prima:not(.template)');
    const materiasPrimas = [];
    
    // Coletar dados das linhas
    linhas.forEach(linha => {
        if (linha.style.display === 'none') return; // Linha removida
        
        const materiaSelect = linha.querySelector('.materia-select');
        const quantidadeInput = linha.querySelector('.quantidade-input');
        
        if (materiaSelect && quantidadeInput && materiaSelect.value && quantidadeInput.value) {
            materiasPrimas.push({
                materia_prima_id: materiaSelect.value,
                quantidade: parseFloat(quantidadeInput.value) || 0
            });
        }
    });
    
    // Se não há matérias-primas, ocultar resumo
    if (materiasPrimas.length === 0) {
        document.getElementById('resumo-custos').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch('{% url "cadastros:api_calcular_custo_produto" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                materias_primas: materiasPrimas
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                // Atualizar resumo de custos
                document.getElementById('custo-total-display').textContent = 
                    `R$ ${data.custo_total.toFixed(2).replace('.', ',')}`;
                document.getElementById('margem-40-display').textContent = 
                    `R$ ${data.margem_sugerida_40.toFixed(2).replace('.', ',')}`;
                document.getElementById('margem-50-display').textContent = 
                    `R$ ${data.margem_sugerida_50.toFixed(2).replace('.', ',')}`;
                
                // Mostrar resumo
                document.getElementById('resumo-custos').style.display = 'block';
                
                // Atualizar campo de preço de custo do produto
                const precoCustoInput = document.querySelector('input[name="preco_custo"]');
                if (precoCustoInput && data.custo_total > 0) {
                    precoCustoInput.value = data.custo_total.toFixed(2);
                }
            }
        }
    } catch (error) {
        console.error('Erro ao calcular custo total:', error);
    }
}

// === MODAL MATÉRIA-PRIMA ===
function abrirModalMateriaPrima() {
    document.getElementById('materiaPrimaModal').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Carregar categorias
    carregarCategoriasMateriaPrima();
}

function fecharModalMateriaPrima() {
    document.getElementById('materiaPrimaModal').classList.remove('show');
    document.body.style.overflow = 'auto';
    document.getElementById('materiaPrimaForm').reset();
}

async function carregarCategoriasMateriaPrima() {
    try {
        // Por enquanto, vamos usar um placeholder
        // Implementar busca de categorias se necessário
        const categoriaSelect = document.querySelector('#materiaPrimaModal select[name="categoria_id"]');
        categoriaSelect.innerHTML = '<option value="">Selecione uma categoria...</option>';
        
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

async function salvarMateriaPrima() {
    const form = document.getElementById('materiaPrimaForm');
    const formData = new FormData(form);
    
    // Adicionar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    try {
        const response = await fetch('{% url "cadastros:criar_materia_prima_rapida" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                // Adicionar nova matéria-prima aos selects
                const selects = document.querySelectorAll('.materia-select');
                selects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = data.materia_prima.id;
                    option.textContent = data.materia_prima.display;
                    select.appendChild(option);
                });
                
                // Fechar modal
                fecharModalMateriaPrima();
                
                // Mostrar notificação
                showNotification('Matéria-prima criada com sucesso!', 'success');
                
                // Se há uma linha sem matéria-prima selecionada, selecionar a nova
                const linhaVazia = document.querySelector('.materia-select[value=""]');
                if (linhaVazia) {
                    linhaVazia.value = data.materia_prima.id;
                    linhaVazia.dispatchEvent(new Event('change'));
                }
            } else {
                showNotification(data.error || 'Erro ao criar matéria-prima', 'error');
            }
        } else {
            const errorData = await response.json();
            showNotification(errorData.error || 'Erro ao criar matéria-prima', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao criar matéria-prima', 'error');
    }
}

// Fechar modais clicando fora
window.addEventListener('click', function(event) {
    const categoriaModal = document.getElementById('categoriaModal');
    const ncmModal = document.getElementById('ncmModal');
    const materiaPrimaModal = document.getElementById('materiaPrimaModal');
    
    if (event.target === categoriaModal) {
        closeCategoriaModal();
    }
    
    if (event.target === ncmModal) {
        closeNCMModal();
    }
    
    if (event.target === materiaPrimaModal) {
        fecharModalMateriaPrima();
    }
});

// Fechar modais com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCategoriaModal();
        closeNCMModal();
        fecharModalMateriaPrima();
    }
});

// Placeholder para modal de tipo de produto (não implementado ainda)
function openTipoProdutoModal() {
    showNotification('Funcionalidade em desenvolvimento', 'info');
}

// === FEEDBACK VISUAL DE GRADES ===
function mostrarFeedbackGrade(tipoGradeId) {
    const feedbackContainer = document.getElementById('grade-feedback');
    const titleText = document.getElementById('feedback-title-text');
    const description = document.getElementById('feedback-description');
    const examplesList = document.getElementById('examples-list');
    const customSection = document.getElementById('feedback-custom');
    
    if (!tipoGradeId) {
        feedbackContainer.style.display = 'none';
        return;
    }
    
    // Mostrar loading
    feedbackContainer.style.display = 'block';
    titleText.textContent = 'Carregando...';
    description.textContent = 'Buscando informações do tipo de grade...';
    examplesList.innerHTML = '';
    customSection.style.display = 'none';
    
    // Buscar dados da grade
    fetch(`{% url "cadastros:buscar_valores_grade" %}?tipo_grade_id=${tipoGradeId}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar título
            titleText.textContent = `Tamanhos: ${data.tipo_grade.nome}`;
            
            // Atualizar descrição
            let descricaoTexto = data.tipo_grade.descricao || '';
            if (data.tipo_grade.tipo === 'NUMEROS') {
                descricaoTexto = 'Este produto usará numeração padrão (tamanhos numéricos). Ideal para calças, sapatos e roupas com medidas específicas.';
            } else if (data.tipo_grade.tipo === 'LETRAS') {
                descricaoTexto = 'Este produto usará grades por letras (PP, P, M, G, etc.). Ideal para roupas casuais e moda em geral.';
            } else if (data.tipo_grade.tipo === 'IDADE') {
                descricaoTexto = 'Este produto usará grades por idade (2, 4, 6 anos, etc.). Ideal para roupas infantis.';
            } else if (data.tipo_grade.tipo === 'PERSONALIZADO') {
                descricaoTexto = 'Este produto usará grades personalizadas conforme configurado no sistema.';
            }
            description.textContent = descricaoTexto;
            
            // Atualizar exemplos
            examplesList.innerHTML = '';
            const tipoClass = data.tipo_grade.tipo.toLowerCase();
            
            if (data.exemplos && data.exemplos.length > 0) {
                data.exemplos.forEach(exemplo => {
                    const tag = document.createElement('span');
                    tag.className = `example-tag ${tipoClass}`;
                    tag.textContent = exemplo;
                    examplesList.appendChild(tag);
                });
            }
            
            // Mostrar seção personalizada se necessário
            if (data.tipo_grade.tipo === 'PERSONALIZADO') {
                customSection.style.display = 'block';
            } else {
                customSection.style.display = 'none';
            }
            
            // Adicionar informação sobre valores cadastrados
            if (data.tem_valores) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'mt-2 text-sm text-success';
                infoDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.valores.length} tamanho(s) já configurado(s) para este tipo de grade.`;
                description.appendChild(infoDiv);
            }
            
        } else {
            // Erro ao buscar dados
            titleText.textContent = 'Erro ao carregar';
            description.textContent = data.error || 'Não foi possível carregar as informações da grade.';
            examplesList.innerHTML = '';
            customSection.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Erro ao buscar valores de grade:', error);
        titleText.textContent = 'Erro de conexão';
        description.textContent = 'Não foi possível conectar ao servidor. Tente novamente.';
        examplesList.innerHTML = '';
        customSection.style.display = 'none';
    });
}

// Event listener para mudança no select de tipo de grade
document.addEventListener('DOMContentLoaded', function() {
    const tipoGradeSelect = document.querySelector('select[name="tipo_grade"]');
    
    if (tipoGradeSelect) {
        // Mostrar feedback inicial se já tem valor
        if (tipoGradeSelect.value) {
            mostrarFeedbackGrade(tipoGradeSelect.value);
        }
        
        // Event listener para mudanças
        tipoGradeSelect.addEventListener('change', function() {
            mostrarFeedbackGrade(this.value);
        });
    }
    
    // Inicializar composição de matérias-primas
    inicializarComposicaoMateriasPrimas();
});

// === MODAL MATERIA PRIMA ===
function abrirModalMateriaPrima() {
    document.getElementById('materiaPrimaModal').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Carregar categorias
    carregarCategoriasMateriaPrima();
}

function fecharModalMateriaPrima() {
    document.getElementById('materiaPrimaModal').classList.remove('show');
    document.body.style.overflow = 'auto';
    document.getElementById('materiaPrimaForm').reset();
}

async function carregarCategoriasMateriaPrima() {
    try {
        // Por enquanto, vamos usar um placeholder
        // Implementar busca de categorias se necessário
        const categoriaSelect = document.querySelector('#materiaPrimaModal select[name="categoria_id"]');
        categoriaSelect.innerHTML = '<option value="">Selecione uma categoria...</option>';
        
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

async function salvarMateriaPrima() {
    const form = document.getElementById('materiaPrimaForm');
    const formData = new FormData(form);
    
    // Adicionar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    try {
        const response = await fetch('{% url "cadastros:criar_materia_prima_rapida" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                // Adicionar nova matéria-prima aos selects
                const selects = document.querySelectorAll('.materia-select');
                selects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = data.materia_prima.id;
                    option.textContent = data.materia_prima.display;
                    select.appendChild(option);
                });
                
                // Fechar modal
                fecharModalMateriaPrima();
                
                // Mostrar notificação
                showNotification('Matéria-prima criada com sucesso!', 'success');
                
                // Se há uma linha sem matéria-prima selecionada, selecionar a nova
                const linhaVazia = document.querySelector('.materia-select[value=""]');
                if (linhaVazia) {
                    linhaVazia.value = data.materia_prima.id;
                    linhaVazia.dispatchEvent(new Event('change'));
                }
            } else {
                showNotification(data.error || 'Erro ao criar matéria-prima', 'error');
            }
        } else {
            const errorData = await response.json();
            showNotification(errorData.error || 'Erro ao criar matéria-prima', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao criar matéria-prima', 'error');
    }
}

// Fechar modais clicando fora
window.addEventListener('click', function(event) {
    const categoriaModal = document.getElementById('categoriaModal');
    const ncmModal = document.getElementById('ncmModal');
    const materiaPrimaModal = document.getElementById('materiaPrimaModal');
    
    if (event.target === categoriaModal) {
        closeCategoriaModal();
    }
    
    if (event.target === ncmModal) {
        closeNCMModal();
    }
    
    if (event.target === materiaPrimaModal) {
        fecharModalMateriaPrima();
    }
});

// Fechar modais com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCategoriaModal();
        closeNCMModal();
        fecharModalMateriaPrima();
    }
});
</script>
{% endblock %} 